<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦´ìŠ¤í”Œë ˆì´ìŠ¤ ì™„ì „íŒ í…ŒìŠ¤íŠ¸</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left h1 { color: #333; margin-bottom: 5px; }
        .header-left p { color: #666; font-size: 14px; }
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-info {
            text-align: right;
            padding-right: 15px;
            border-right: 2px solid #eee;
        }
        .user-info .user-name {
            font-weight: bold;
            color: #333;
        }
        .user-info .user-email {
            font-size: 12px;
            color: #666;
        }
        .login-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .login-status.logged-in {
            background: #d4edda;
            color: #155724;
        }
        .login-status.logged-out {
            background: #f8d7da;
            color: #721c24;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .test-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .test-card.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        .test-card h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; color: white; }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #555;
            font-weight: 600;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .result-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }
        .result-box pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
        }
        .log-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .log-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-success { color: #b5cea8; }
        .log-error { color: #f48771; }
        .log-info { color: #4ec9b0; }
        .log-warn { color: #dcdcaa; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .flow-indicator {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 13px;
        }
        .list-item {
            background: white;
            border: 1px solid #ddd;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .list-item-info { flex: 1; }
        .list-item-info strong { display: block; margin-bottom: 4px; }
        .list-item-info small { color: #666; display: block; }
        .list-item-actions { display: flex; gap: 5px; }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .auth-required {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            color: #721c24;
            font-size: 13px;
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header with Auth Status -->
    <div class="header">
        <div class="header-left">
            <h1>ğŸ§ª ë¦´ìŠ¤í”Œë ˆì´ìŠ¤ ì™„ì „íŒ í…ŒìŠ¤íŠ¸</h1>
            <p>ë¡œê·¸ì¸ë¶€í„° ì „ì²´ í”Œë¡œìš°ê¹Œì§€ ëª¨ë“  API í…ŒìŠ¤íŠ¸</p>
        </div>
        <div class="header-right">
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-name" id="userName"></div>
                <div class="user-email" id="userEmail"></div>
            </div>
            <div class="login-status logged-out" id="loginStatus">
                ğŸ”’ ë¡œê·¸ì¸ í•„ìš”
            </div>
        </div>
    </div>

    <!-- í…ŒìŠ¤íŠ¸ ê·¸ë¦¬ë“œ -->
    <div class="test-grid">
        <!-- 0. ë¡œê·¸ì¸ -->
        <div class="test-card" id="authCard">
            <h3>ğŸ” 0. ì¸ì¦ (Auth)</h3>
            <div class="flow-indicator">
                ğŸ’¡ í…ŒìŠ¤íŠ¸ìš© ê°„í¸ ë¡œê·¸ì¸
            </div>

            <div id="loginForm">
                <div class="input-group">
                    <label>Provider</label>
                    <select id="provider">
                        <option value="GOOGLE">Google</option>
                        <option value="KAKAO">Kakao</option>
                        <option value="NAVER">Naver</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Nickname</label>
                    <input type="text" id="nickname" value="í…ŒìŠ¤í„°" placeholder="ë‹‰ë„¤ì„">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="email" value="test@example.com" placeholder="ì´ë©”ì¼">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="login()">
                        ğŸ”“ ë¡œê·¸ì¸
                    </button>
                    <button class="btn btn-warning" onclick="quickLogin()">
                        âš¡ ë¹ ë¥¸ ë¡œê·¸ì¸
                    </button>
                </div>
            </div>

            <div id="logoutForm" style="display: none;">
                <div class="btn-group">
                    <button class="btn btn-info" onclick="getMyInfo()">
                        ğŸ‘¤ ë‚´ ì •ë³´ ì¡°íšŒ
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        ğŸšª ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>

            <div class="result-box" id="authResult"></div>
        </div>

        <!-- 1. ë¦´ìŠ¤ ì €ì¥ -->
        <div class="test-card" id="reelCard">
            <h3>ğŸ“ 1. ë¦´ìŠ¤ ì €ì¥</h3>
            <div class="flow-indicator">
                ğŸ’¡ ì¸ìŠ¤íƒ€ URL ì €ì¥ â†’ ìë™ íŒŒì‹±
            </div>
            <div class="input-group">
                <label>Instagram Reel URL</label>
                <input type="text" id="reelUrl"
                       value="https://www.instagram.com/reel/test"
                       placeholder="https://www.instagram.com/reel/...">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveReel()">
                    ğŸš€ ë¦´ìŠ¤ ì €ì¥
                </button>
                <button class="btn btn-warning" onclick="saveReelWithMockData()">
                    ğŸ§ª Mock ë°ì´í„°ë¡œ ì €ì¥
                </button>
            </div>
            <div class="result-box" id="saveReelResult"></div>
        </div>

        <!-- 2. ë‚´ ë¦´ìŠ¤ ëª©ë¡ -->
        <div class="test-card" id="reelListCard">
            <h3>ğŸ“‹ 2. ë‚´ ë¦´ìŠ¤ ëª©ë¡</h3>
            <div class="flow-indicator">
                ğŸ’¡ ì €ì¥ëœ ë¦´ìŠ¤ í™•ì¸
            </div>
            <div class="input-group">
                <label>Page / Size</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="reelPage" value="0" style="width: 80px;">
                    <input type="number" id="reelSize" value="10" style="width: 80px;">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-info" onclick="getMyReels()">
                    ğŸ“‹ ëª©ë¡ ì¡°íšŒ
                </button>
            </div>
            <div class="result-box" id="myReelsResult"></div>
        </div>

        <!-- 3. ë‚´ ì¥ì†Œ ëª©ë¡ -->
        <div class="test-card" id="placeListCard">
            <h3>ğŸ“ 3. ë‚´ ì¥ì†Œ ëª©ë¡</h3>
            <div class="flow-indicator">
                ğŸ’¡ ìƒì„±ëœ ì¥ì†Œ í™•ì¸
            </div>
            <div class="input-group">
                <label>Page / Size</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="placePage" value="0" style="width: 80px;">
                    <input type="number" id="placeSize" value="10" style="width: 80px;">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-info" onclick="getMyPlaces()">
                    ğŸ“ ëª©ë¡ ì¡°íšŒ
                </button>
            </div>
            <div class="result-box" id="myPlacesResult"></div>
        </div>

        <!-- 4. í†µê³„ -->
        <div class="test-card" id="statsCard">
            <h3>ğŸ“Š 4. ë§ˆì´í˜ì´ì§€ í†µê³„</h3>
            <div class="flow-indicator">
                ğŸ’¡ ë¦´ìŠ¤/ì¥ì†Œ ê°œìˆ˜, ì§€ë„ ì—´ê¸°
            </div>
            <div class="btn-group">
                <button class="btn btn-info" onclick="getStats()">
                    ğŸ“Š í†µê³„ ì¡°íšŒ
                </button>
            </div>
            <div id="statsResult"></div>
        </div>

        <!-- 5. ë¦´ìŠ¤ ì‚­ì œ -->
        <div class="test-card" id="deleteCard">
            <h3>ğŸ—‘ï¸ 5. ë¦´ìŠ¤ ì‚­ì œ</h3>
            <div class="flow-indicator">
                ğŸ’¡ ë¦´ìŠ¤ ì‚­ì œ (ì¥ì†ŒëŠ” ìœ ì§€)
            </div>
            <div class="input-group">
                <label>Reel ID</label>
                <input type="number" id="deleteReelId" placeholder="ë¦´ìŠ¤ ID">
            </div>
            <div class="btn-group">
                <button class="btn btn-danger" onclick="deleteReel()">
                    ğŸ—‘ï¸ ë¦´ìŠ¤ ì‚­ì œ
                </button>
            </div>
            <div class="result-box" id="deleteReelResult"></div>
        </div>

        <!-- 6. ì „ì²´ í”Œë¡œìš° -->
        <div class="test-card" id="flowCard">
            <h3>ğŸ”„ 6. ì „ì²´ í”Œë¡œìš°</h3>
            <div class="flow-indicator">
                ğŸ’¡ ë¦´ìŠ¤ ì €ì¥ â†’ íŒŒì‹± â†’ ì£¼ì†Œ â†’ ì¥ì†Œ
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="runFullFlow()">
                    ğŸš€ ì „ì²´ í”Œë¡œìš° ì‹¤í–‰
                </button>
            </div>
            <div class="result-box" id="fullFlowResult"></div>
        </div>
    </div>

    <!-- ë¡œê·¸ -->
    <div class="log-section">
        <h3>ğŸ“‹ ì‹¤í–‰ ë¡œê·¸</h3>
        <div class="btn-group">
            <button class="btn btn-danger" onclick="clearLog()">
                ğŸ—‘ï¸ ë¡œê·¸ ì´ˆê¸°í™”
            </button>
        </div>
        <div class="log-box" id="logBox"></div>
    </div>
</div>

<script>
    let accessToken = null;
    let currentUser = null;

    const MOCK_CAPTION = `ğŸ• ì˜¤ëŠ˜ì˜ ë§›ì§‘ íƒë°©!

ì§„ì§œ ë§›ìˆëŠ” í”¼ì ì§‘ ì°¾ì•˜ì–´ìš”!
ì£¼ì†Œ: ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ ì—°ë‚¨ë™ 239-10

ğŸ“ ìœ„ì¹˜ ì •ë³´
- ì§€í•˜ì²  2í˜¸ì„  í™ëŒ€ì…êµ¬ì—­ 3ë²ˆ ì¶œêµ¬
- ë„ë³´ 10ë¶„ ê±°ë¦¬

ğŸ’° ê°€ê²©ëŒ€: 1.5~2ë§Œì›
â­ ë³„ì : 4.8/5.0

#ì—°ë‚¨ë™ë§›ì§‘ #í”¼ìë§›ì§‘`;

    // ë¡œê·¸
    function log(type, msg) {
        const box = document.getElementById('logBox');
        const div = document.createElement('div');
        div.className = `log-${type}`;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function clearLog() {
        document.getElementById('logBox').innerHTML = '';
        log('info', 'ë¡œê·¸ ì´ˆê¸°í™”');
    }

    function showResult(elementId, data, isError = false) {
        const elem = document.getElementById(elementId);
        elem.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        elem.style.background = isError ? '#f8d7da' : '#d4edda';
    }

    // UI ì—…ë°ì´íŠ¸
    function updateLoginUI(loggedIn) {
        const status = document.getElementById('loginStatus');
        const userInfo = document.getElementById('userInfo');
        const loginForm = document.getElementById('loginForm');
        const logoutForm = document.getElementById('logoutForm');

        // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì¹´ë“œ í™œì„±í™”/ë¹„í™œì„±í™”
        const protectedCards = ['reelCard', 'reelListCard', 'placeListCard',
            'statsCard', 'deleteCard', 'flowCard'];

        if (loggedIn) {
            status.className = 'login-status logged-in';
            status.textContent = 'âœ… ë¡œê·¸ì¸ë¨';
            userInfo.style.display = 'block';
            loginForm.style.display = 'none';
            logoutForm.style.display = 'block';

            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.nickname || 'User';
                document.getElementById('userEmail').textContent = currentUser.email || '';
            }

            protectedCards.forEach(id => {
                document.getElementById(id).classList.remove('disabled');
            });
        } else {
            status.className = 'login-status logged-out';
            status.textContent = 'ğŸ”’ ë¡œê·¸ì¸ í•„ìš”';
            userInfo.style.display = 'none';
            loginForm.style.display = 'block';
            logoutForm.style.display = 'none';

            protectedCards.forEach(id => {
                document.getElementById(id).classList.add('disabled');
            });
        }
    }

    // 0. ë¡œê·¸ì¸
    async function login() {
        const provider = document.getElementById('provider').value;
        const nickname = document.getElementById('nickname').value;
        const email = document.getElementById('email').value;

        if (!nickname) {
            alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!');
            return;
        }

        log('info', 'ë¡œê·¸ì¸ ì‹œë„...');

        try {
            const res = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider,
                    providerUserId: 'test_' + Date.now(),
                    email,
                    nickname,
                    defaultMapApp: 'GOOGLE'
                })
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();
            accessToken = data.accessToken;
            currentUser = data.user;

            log('success', `âœ… ë¡œê·¸ì¸ ì„±ê³µ! (${currentUser.nickname})`);
            log('info', `   - Access Token: ${accessToken.substring(0, 20)}...`);

            updateLoginUI(true);
            showResult('authResult', data);

        } catch (error) {
            log('error', `âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`);
            showResult('authResult', { error: error.message }, true);
        }
    }

    async function quickLogin() {
        document.getElementById('nickname').value = 'í…ŒìŠ¤í„°';
        document.getElementById('email').value = 'test@reelsplace.com';
        await login();
    }

    async function logout() {
        log('info', 'ë¡œê·¸ì•„ì›ƒ ì‹œë„...');

        try {
            const res = await fetch('/api/v1/auth/logout', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            accessToken = null;
            currentUser = null;

            log('success', 'âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
            updateLoginUI(false);
            showResult('authResult', data);

        } catch (error) {
            log('error', `âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`);
            showResult('authResult', { error: error.message }, true);
        }
    }

    async function getMyInfo() {
        log('info', 'ë‚´ ì •ë³´ ì¡°íšŒ...');

        try {
            const res = await fetch('/api/v1/users/me', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();
            currentUser = data;

            log('success', 'âœ… ë‚´ ì •ë³´ ì¡°íšŒ ì™„ë£Œ');
            log('info', `   - ID: ${data.id}`);
            log('info', `   - ë‹‰ë„¤ì„: ${data.nickname}`);
            log('info', `   - ì´ë©”ì¼: ${data.email || 'N/A'}`);

            showResult('authResult', data);
            updateLoginUI(true);

        } catch (error) {
            log('error', `âŒ ë‚´ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
            showResult('authResult', { error: error.message }, true);
        }
    }

    // í—¤ë” ìƒì„± í—¬í¼
    function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        };
    }

    // 1. ë¦´ìŠ¤ ì €ì¥
    async function saveReel() {
        const url = document.getElementById('reelUrl').value;

        if (!url) {
            alert('URLì„ ì…ë ¥í•˜ì„¸ìš”!');
            return;
        }

        log('info', 'ë¦´ìŠ¤ ì €ì¥ ì‹œì‘...');

        try {
            const res = await fetch('/api/v1/reels', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ reelUrl: url })
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            log('success', `âœ… ë¦´ìŠ¤ ì €ì¥ ì™„ë£Œ (ID: ${data.reelId})`);
            showResult('saveReelResult', data);

        } catch (error) {
            log('error', `âŒ ë¦´ìŠ¤ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
            showResult('saveReelResult', { error: error.message }, true);
        }
    }

    async function saveReelWithMockData() {
        log('info', 'Mock ë°ì´í„°ë¡œ ë¦´ìŠ¤ ìƒì„±...');

        try {
            const res = await fetch('/api/v1/test/reels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reelUrl: 'https://www.instagram.com/reel/test_' + Date.now(),
                    thumbnailUrl: 'https://via.placeholder.com/400',
                    caption: MOCK_CAPTION
                })
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            log('success', `âœ… Mock ë¦´ìŠ¤ ìƒì„± (ID: ${data.reelId})`);
            showResult('saveReelResult', data);

            // ìë™ìœ¼ë¡œ ì£¼ì†Œ ì¶”ì¶œ
            setTimeout(() => extractAddresses(data.reelId), 2000);

        } catch (error) {
            log('error', `âŒ Mock ë¦´ìŠ¤ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
            showResult('saveReelResult', { error: error.message }, true);
        }
    }

    async function extractAddresses(reelId) {
        log('info', `ì£¼ì†Œ ì¶”ì¶œ... (ID: ${reelId})`);

        try {
            const res = await fetch(`/api/v1/internal/reels/${reelId}/extract-addresses`, {
                method: 'POST'
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            log('success', `âœ… ì£¼ì†Œ ${data.addresses.length}ê°œ ì¶”ì¶œ`);

            if (data.addresses.length > 0) {
                await createPlaces(reelId, data.addresses);
            }

        } catch (error) {
            log('error', `âŒ ì£¼ì†Œ ì¶”ì¶œ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    async function createPlaces(reelId, addresses) {
        log('info', 'ì¥ì†Œ ìƒì„±...');

        try {
            const res = await fetch(`/api/v1/internal/reels/${reelId}/create-places`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ addresses })
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            log('success', `âœ… ì¥ì†Œ ${data.createdPlaces.length}ê°œ ìƒì„±`);

        } catch (error) {
            log('error', `âŒ ì¥ì†Œ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
        }
    }

    // 2. ë¦´ìŠ¤ ëª©ë¡
    async function getMyReels() {
        const page = document.getElementById('reelPage').value;
        const size = document.getElementById('reelSize').value;

        log('info', `ë¦´ìŠ¤ ëª©ë¡ ì¡°íšŒ... (page=${page}, size=${size})`);

        try {
            const res = await fetch(`/api/v1/reels?page=${page}&size=${size}`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            log('success', `âœ… ë¦´ìŠ¤ ${data.content.length}ê°œ ì¡°íšŒ`);

            let html = `<div style="font-weight: bold; margin-bottom: 10px;">ì´ ${data.totalElements}ê°œ</div>`;
            data.content.forEach(reel => {
                html += `
                <div class="list-item">
                    <div class="list-item-info">
                        <strong>ID: ${reel.reelId} ${getStatusBadge(reel.status)}</strong>
                        <small>${reel.reelUrl}</small>
                    </div>
                </div>
            `;
            });

            document.getElementById('myReelsResult').innerHTML = html;

        } catch (error) {
            log('error', `âŒ ë¦´ìŠ¤ ëª©ë¡ ì‹¤íŒ¨: ${error.message}`);
            showResult('myReelsResult', { error: error.message }, true);
        }
    }

    // 3. ì¥ì†Œ ëª©ë¡
    async function getMyPlaces() {
        const page = document.getElementById('placePage').value;
        const size = document.getElementById('placeSize').value;

        log('info', `ì¥ì†Œ ëª©ë¡ ì¡°íšŒ... (page=${page}, size=${size})`);

        try {
            const res = await fetch(`/api/v1/places?page=${page}&size=${size}`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            log('success', `âœ… ì¥ì†Œ ${data.content.length}ê°œ ì¡°íšŒ`);

            let html = `<div style="font-weight: bold; margin-bottom: 10px;">ì´ ${data.totalElements}ê°œ</div>`;
            data.content.forEach(place => {
                html += `
                <div class="list-item">
                    <div class="list-item-info">
                        <strong>ğŸ“ ${place.name}</strong>
                        <small>${place.address}</small>
                    </div>
                </div>
            `;
            });

            document.getElementById('myPlacesResult').innerHTML = html;

        } catch (error) {
            log('error', `âŒ ì¥ì†Œ ëª©ë¡ ì‹¤íŒ¨: ${error.message}`);
            showResult('myPlacesResult', { error: error.message }, true);
        }
    }

    // 4. í†µê³„
    async function getStats() {
        log('info', 'í†µê³„ ì¡°íšŒ...');

        try {
            const res = await fetch('/api/v1/users/me/stats', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            log('success', 'âœ… í†µê³„ ì¡°íšŒ ì™„ë£Œ');

            const html = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">${data.reelCount}</div>
                    <div class="stat-label">ë¦´ìŠ¤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.placeCount}</div>
                    <div class="stat-label">ì¥ì†Œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.mapOpenCount}</div>
                    <div class="stat-label">ì§€ë„ ì—´ê¸°</div>
                </div>
            </div>
        `;

            document.getElementById('statsResult').innerHTML = html;

        } catch (error) {
            log('error', `âŒ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    // 5. ë¦´ìŠ¤ ì‚­ì œ
    async function deleteReel() {
        const reelId = document.getElementById('deleteReelId').value;

        if (!reelId) {
            alert('ë¦´ìŠ¤ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
            return;
        }

        if (!confirm(`ë¦´ìŠ¤ ${reelId} ì‚­ì œ?`)) return;

        log('info', `ë¦´ìŠ¤ ì‚­ì œ... (ID: ${reelId})`);

        try {
            const res = await fetch(`/api/v1/reels/${reelId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            log('success', `âœ… ë¦´ìŠ¤ ì‚­ì œ ì™„ë£Œ`);
            showResult('deleteReelResult', { message: 'ì‚­ì œ ì™„ë£Œ' });

        } catch (error) {
            log('error', `âŒ ë¦´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
            showResult('deleteReelResult', { error: error.message }, true);
        }
    }

    // 6. ì „ì²´ í”Œë¡œìš°
    async function runFullFlow() {
        log('info', '========== ì „ì²´ í”Œë¡œìš° ì‹œì‘ ==========');

        try {
            // Mock ë¦´ìŠ¤ ìƒì„±
            log('info', 'STEP 1: Mock ë¦´ìŠ¤ ìƒì„±...');
            const res1 = await fetch('/api/v1/test/reels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reelUrl: 'https://www.instagram.com/reel/test_' + Date.now(),
                    thumbnailUrl: 'https://via.placeholder.com/400',
                    caption: MOCK_CAPTION
                })
            });

            if (!res1.ok) throw new Error('ë¦´ìŠ¤ ìƒì„± ì‹¤íŒ¨');

            const reelData = await res1.json();
            const reelId = reelData.reelId;

            log('success', `âœ… ë¦´ìŠ¤ ìƒì„± (ID: ${reelId})`);

            await new Promise(r => setTimeout(r, 2000));

            // ì£¼ì†Œ ì¶”ì¶œ
            log('info', 'STEP 2: ì£¼ì†Œ ì¶”ì¶œ...');
            const res2 = await fetch(`/api/v1/internal/reels/${reelId}/extract-addresses`, {
                method: 'POST'
            });

            if (!res2.ok) throw new Error('ì£¼ì†Œ ì¶”ì¶œ ì‹¤íŒ¨');

            const addrData = await res2.json();
            log('success', `âœ… ì£¼ì†Œ ${addrData.addresses.length}ê°œ ì¶”ì¶œ`);

            if (addrData.addresses.length === 0) {
                log('warn', 'âš ï¸ ì£¼ì†Œ ì—†ìŒ');
                return;
            }

            // ì¥ì†Œ ìƒì„±
            log('info', 'STEP 3: ì¥ì†Œ ìƒì„±...');
            const res3 = await fetch(`/api/v1/internal/reels/${reelId}/create-places`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ addresses: addrData.addresses })
            });

            if (!res3.ok) throw new Error('ì¥ì†Œ ìƒì„± ì‹¤íŒ¨');

            const placeData = await res3.json();
            log('success', `âœ… ì¥ì†Œ ${placeData.createdPlaces.length}ê°œ ìƒì„±`);

            // í†µê³„ í™•ì¸
            await getStats();

            log('success', '========== ì „ì²´ í”Œë¡œìš° ì™„ë£Œ! ==========');

            showResult('fullFlowResult', {
                reelId,
                addresses: addrData.addresses.length,
                places: placeData.createdPlaces.length
            });

        } catch (error) {
            log('error', `âŒ ì „ì²´ í”Œë¡œìš° ì‹¤íŒ¨: ${error.message}`);
            showResult('fullFlowResult', { error: error.message }, true);
        }
    }

    // ìœ í‹¸
    function getStatusBadge(status) {
        const badges = {
            'PROCESSING': '<span class="badge badge-info">ì²˜ë¦¬ì¤‘</span>',
            'METADATA_PARSED': '<span class="badge badge-info">íŒŒì‹±ì™„ë£Œ</span>',
            'NO_ADDRESS': '<span class="badge badge-warning">ì£¼ì†Œì—†ìŒ</span>',
            'PLACE_FOUND': '<span class="badge badge-success">ì¥ì†Œìƒì„±</span>',
            'PLACE_NOT_FOUND': '<span class="badge badge-danger">ì¥ì†Œì—†ìŒ</span>',
            'FAILED': '<span class="badge badge-danger">ì‹¤íŒ¨</span>'
        };
        return badges[status] || `<span class="badge">${status}</span>`;
    }

    // ì´ˆê¸°í™”
    updateLoginUI(false);
    log('success', 'âœ¨ ë¦´ìŠ¤í”Œë ˆì´ìŠ¤ ì™„ì „íŒ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ!');
    log('info', 'ë¨¼ì € "âš¡ ë¹ ë¥¸ ë¡œê·¸ì¸"ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”!\n');
</script>
</body>
</html>