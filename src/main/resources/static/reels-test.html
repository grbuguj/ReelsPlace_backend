<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ReelsPlace - ì €ì¥ëœ ì¥ì†Œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; background:#f5f6f8; padding:20px; }
        h1 { text-align:center; margin-bottom:24px; }
        .actions { display:flex; justify-content:center; gap:10px; margin-bottom:20px; }
        button { padding:10px 18px; border-radius:8px; border:none; background:#4f46e5; color:#fff; font-weight:600; cursor:pointer; }
        button:hover { background:#4338ca; }
        .grid { max-width:1200px; margin:0 auto; display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:20px; }
        .card { background:#fff; border-radius:14px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08); transition:transform .2s; }
        .card:hover { transform:translateY(-4px); }
        .card img { width:100%; height:180px; object-fit:cover; background:#eee; display:block; }
        .card-body { padding:14px; }
        .name { font-size:16px; font-weight:700; margin-bottom:6px; }
        .meta { font-size:14px; color:#555; margin-bottom:6px; }
        .address { font-size:13px; color:#777; line-height:1.4; }
        .empty { text-align:center; color:#888; margin-top:40px; }
        .error { text-align:center; color:#c0392b; margin-top:20px; white-space:pre-wrap; }
        .loading { text-align:center; color:#666; margin-top:20px; }
    </style>
</head>

<body>
<h1>ğŸ“ ì €ì¥ëœ ì¥ì†Œ</h1>

<div class="actions">
    <button id="btnReload">ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="btnClearToken" style="background:#e74c3c;">í† í° ì‚­ì œ</button>
</div>

<div id="loading" class="loading" style="display:none;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
<div id="error" class="error" style="display:none;"></div>

<div id="grid" class="grid"></div>

<div id="empty" class="empty" style="display:none;">
    ì €ì¥ëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.
</div>

<script>
    function $(id) { return document.getElementById(id); }

    function show(el, on) { el.style.display = on ? "block" : "none"; }

    function safeGetPlaces(json) {
        // ë„¤ê°€ ì˜¬ë¦° ì‘ë‹µ êµ¬ì¡°: { status:200, data:{ content:[...] ... } }
        // í˜¹ì‹œ í•œë²ˆ ë” ê°ì‹¸ì§„ ê²½ìš°ë„ ëŒ€ë¹„
        return json?.data?.content
            ?? json?.data?.data?.content
            ?? json?.content
            ?? [];
    }

    async function loadPlaces() {
        const accessToken = localStorage.getItem("accessToken");
        console.log("accessToken:", accessToken);

        $("grid").innerHTML = "";
        show($("empty"), false);
        show($("error"), false);
        show($("loading"), true);

        if (!accessToken) {
            show($("loading"), false);
            show($("error"), true);
            $("error").textContent = "accessTokenì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸ í›„ localStorageì— accessTokenì´ ì €ì¥ë¼ì•¼ í•©ë‹ˆë‹¤.";
            return;
        }

        try {
            const res = await fetch("/api/v1/places", {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            console.log("status:", res.status);

            // 401/403 ê°™ì€ ê²½ìš° JSONì´ ì•„ë‹ ìˆ˜ë„ ìˆì–´ì„œ ë°©ì–´
            const text = await res.text();
            let json;
            try { json = JSON.parse(text); }
            catch (e) {
                throw new Error("ì‘ë‹µì´ JSONì´ ì•„ë‹˜:\n" + text);
            }

            console.log("response:", json);

            const places = safeGetPlaces(json);
            console.log("places extracted:", places, "isArray:", Array.isArray(places), "len:", places?.length);

            renderPlaces(places);

        } catch (err) {
            show($("error"), true);
            $("error").textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:\n" + (err?.message ?? err);
        } finally {
            show($("loading"), false);
        }
    }

    function renderPlaces(places) {
        const grid = $("grid");
        const empty = $("empty");

        grid.innerHTML = "";

        if (!Array.isArray(places) || places.length === 0) {
            show(empty, true);
            return;
        }

        show(empty, false);

        places.forEach(place => {
            const imageUrl = (place.images && place.images.length > 0)
                ? place.images[0]
                : "https://via.placeholder.com/400x300?text=No+Image";

            const card = document.createElement("div");
            card.className = "card";

            card.innerHTML = `
          <img src="${imageUrl}" alt="${place.name ?? ""}" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'"/>
          <div class="card-body">
            <div class="name">${place.name ?? "-"}</div>
            <div class="meta">â­ ${place.rating ?? "N/A"} Â· ë¦¬ë·° ${place.reviewCount ?? 0}ê°œ</div>
            <div class="address">${place.address ?? "-"}</div>
          </div>
        `;

            grid.appendChild(card);
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        $("btnReload").addEventListener("click", loadPlaces);
        $("btnClearToken").addEventListener("click", () => {
            localStorage.removeItem("accessToken");
            localStorage.removeItem("refreshToken");
            alert("í† í° ì‚­ì œ ì™„ë£Œ");
        });

        loadPlaces(); // ìë™ ë¡œë“œ
    });
</script>
</body>
</html>
